<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="/js/src/vendor/index-min.js"></script>

    <style>
        body {
            background: #F0F0F0;
            color: #000000;
        }

        .container {
            margin: 2rem auto;
            padding: 1rem;
            max-width: 480px;
            width: 80%;

            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .container * {
            margin: 1rem 0;
            overflow-wrap: anywhere;
        }

        .container .all {
            background: #fffde7;
            color: #b71c1c;
            padding: .5rem 1rem;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgb(0 0 0 / 10%);
            border-bottom: 1px solid #ddd;
            margin: .5rem 0 0 0;
        }
    </style>
</head>

<body>

    <div class="container">
        <div id="teste"></div>

        <a href="https://github.com/jakearchibald/idb#examples">Exemplos no Github</a>
        <button onclick="Limpar()">Limpar IndexedDb</button>
    </div>

    <!-- <div class="cht-msg" id="cht-msg-1">
        <div class="cht-msg-text">Olá!<br>Tudo bem com você?</div>
        <div class="cht-msg-data">
            <span class="cht-date"></span>
            <span class="cht-status">
                <i class="material-icons">check_circle_outline</i>
            </span>
        </div>
    </div>
    <div class="cht-msg me" id="cht-msg-1">
        <div class="cht-msg-text">Sim, tudo bem por aqui</div>
        <div class="cht-msg-data">
            <span class="cht-date"></span>
            <span class="cht-status">
                <i class="material-icons">check_circle_outline</i>
            </span>
        </div>
    </div>
    <div class="cht-msg" id="cht-msg-1">
        <div class="cht-msg-text">Então...<br>Precisamos falar sobre o Tony!</div>
        <div class="cht-msg-data">
            <span class="cht-date"></span>
            <span class="cht-status">
                <i class="material-icons">check_circle_outline</i>
            </span>
        </div>
    </div>
    <div class="cht-msg me" id="cht-msg-1">
        <div class="cht-msg-text">Mussum Ipsum, cacilds vidis litro abertis. Quem manda na minha terra
            sou euzis! Quem num gosta di mim que vai caçá sua turmis! Interagi no mé, cursus quis,
            vehicula ac nisi. Posuere libero varius. Nullam a nisl ut ante blandit hendrerit. Aenean sit
            amet nisi.</div>
        <div class="cht-msg-data">
            <span class="cht-date"></span>
            <span class="cht-status">
                <i class="material-icons">check_circle_outline</i>
            </span>
        </div>
    </div>
    <div class="cht-msg" id="cht-msg-1">
        <div class="cht-msg-text">Vamos marcar para amanhã na parte da manhã?</div>
        <div class="cht-msg-data">
            <span class="cht-date"></span>
            <span class="cht-status">
                <i class="material-icons">check_circle_outline</i>
            </span>
        </div>
    </div> -->



    <script>
        var DB = function (database, dbkey) {

            database = database || 'electronizer'
            dbkey = dbkey || 'user'

            let conn = idb.openDB(database, 1, {
                upgrade(r) {
                    const s = r.createObjectStore(dbkey, {
                        keyPath: 'id',
                        autoIncrement: true,
                    })

                    s.createIndex('name', 'name')
                    s.createIndex('id', 'id')

                    // Segundo registro
                    const s2 = r.createObjectStore('app', {
                        keyPath: 'id',
                        autoIncrement: true,
                    })

                    s2.createIndex('name', 'name')
                    s2.createIndex('id', 'id')
                }
            })

            const get = async key => (await conn).get(dbkey, key)
            const set = async (key, val) => (await conn).put(dbkey, val, key)
            const del = async key => (await conn).delete(dbkey, key)
            const clear = async () => (await conn).clear(dbkey)
            const keys = async () => (await conn).getAllKeys(dbkey)

            const add = async data => (await conn).add(dbkey, data)
            const getAll = async index => (await conn).getAllFromIndex(dbkey, index || 'name')

            const upd = async (ukey, data) => {
                db = await conn
                return db.delete(dbkey, ukey).then(() => db.add(dbkey, data))
            }

            return {
                add,
                getAll,
                get,
                set,
                del,
                clear,
                keys,
                upd,
            }
        }


        var DBA = function (dtb) {

            dtb = dtb || 'elize'
            pkg = ['user', 'auth']

            let conn = idb.openDB(dtb, 1, {
                upgrade(r) { // Create a Schema if empty

                    // User pack --------------------------
                    let u = r.createObjectStore('user', {
                        keyPath: 'id',
                        autoIncrement: true,
                    })

                    u.createIndex('name', 'name')
                    u.createIndex('id', 'id')

                    // Auth pack --------------------------
                    let a = r.createObjectStore('auth', {
                        keyPath: 'id',
                        autoIncrement: true
                    })
                    a.createIndex('id', 'id')
                }
            })

            const ck = p => pkg.indexOf(p) >= 0 ? p : false

            const get = async (p, k) => (await conn).get(ck(p), k)
            const set = async (p, k, v) => (await conn).put(ck(p), v, k)
            const del = async (p, k) => (await conn).delete(ck(p), k)
            const clear = async (p) => (await conn).clear(ck(p))
            const keys = async (p) => (await conn).getAllKeys(ck(p))

            const add = async (p, d) => (await conn).add(ck(p), d)
            const getAll = async (p, i) => (await conn).getAllFromIndex(ck(p), i || 'name')

            const upd = async (p, uk, d) => {
                db = await conn
                return db.delete(ck(p), uk).then(() => db.add(ck(p), d))
            }

            return {
                add,
                getAll,
                get,
                set,
                del,
                clear,
                keys,
                upd,
            }
        }

        const Limpar = () => {
            UserDb.clear().then(a => location.reload())
        }

        const UserDb = new DB

        //const DBase = new DBA

        UserDb.keys().then(k => {
            console.log('First ID:', k[0])
        })

        UserDb.keys().then(k => {
            UserDb.get(k[0]).then(v => {
                document.querySelector("#teste").innerHTML = '<div>' + JSON.stringify(v) + '</div>'
            })
        })

        UserDb.add({
            name: "Maria Virgilho",
            tokey: "aiaddsaçdjgasdkj"
        }).then(a => console.log("Add", a))

        UserDb.add({
            name: "Paulo Rocha",
            tokey: "saçdjgasdkj"
        }).then(a => console.log("Add", a))

        UserDb.keys().then(a => console.log(a))
        UserDb.getAll('id').then(a => {
            d = ''
            a.forEach(x => d += '<div class="all">' + JSON.stringify(x) + '</div>')
            document.querySelector("#teste").innerHTML += d
            console.log(a)
        })


        // Update
        UserDb.keys().then(k => {
            UserDb.get(k[0]).then(v => { // get data... 
                v.avatar = "/img/u/1/avatar.png" // add a avatar...
                v.date = new Date()
                UserDb.upd(k[0], v).then(b => { // delete and save.

                    // Verificando se o avatar foi gravado!!
                    UserDb.get(k[0]).then(v => {
                        console.log("User Avatar: ", v.avatar)

                        document.querySelector("#teste").innerHTML += '<div>' + JSON
                            .stringify(v) +
                            '</div>'
                    })
                })
            })
        })
    </script>

</body>

</html>